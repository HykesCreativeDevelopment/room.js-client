!function(t){"use strict";function e(t,e){return e={exports:{}},t(e,e.exports),e.exports}function n(t,e,n){var i=n.get("codemirrorOptions")||{};i.value=ko.unwrap(e());var o=CodeMirror(t,i);o.on("change",function(t){var n=e();n(t.getValue())}),t.editor=o}function i(t,e){var n=ko.unwrap(e());if(t.editor){var i=n!==t.editor.getValue();i&&(t.editor.setValue(n),t.editor.refresh())}}function o(){ko.bindingHandlers.codemirror={init:n,update:i}}function s(t){return v(p(t))}function r(t){return b(t)}function a(t){return"[1m[31m"+t+"[39m[22m"}function c(t){return"[1m[32m"+t+"[39m[22m"}function h(t){return"[90m"+t+"[39m"}var u={};u.classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},u.createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),u.toArray=function(t){return Array.isArray(t)?t:Array.from(t)};var l={register:o},d=e(function(t){!function(e,n){function i(){this.fg=this.bg=this.fg_truecolor=this.bg_truecolor=null,this.bright=0}var o,s,r="undefined"!=typeof t,a=[[{color:"0, 0, 0","class":"ansi-black"},{color:"187, 0, 0","class":"ansi-red"},{color:"0, 187, 0","class":"ansi-green"},{color:"187, 187, 0","class":"ansi-yellow"},{color:"0, 0, 187","class":"ansi-blue"},{color:"187, 0, 187","class":"ansi-magenta"},{color:"0, 187, 187","class":"ansi-cyan"},{color:"255,255,255","class":"ansi-white"}],[{color:"85, 85, 85","class":"ansi-bright-black"},{color:"255, 85, 85","class":"ansi-bright-red"},{color:"0, 255, 0","class":"ansi-bright-green"},{color:"255, 255, 85","class":"ansi-bright-yellow"},{color:"85, 85, 255","class":"ansi-bright-blue"},{color:"255, 85, 255","class":"ansi-bright-magenta"},{color:"85, 255, 255","class":"ansi-bright-cyan"},{color:"255, 255, 255","class":"ansi-bright-white"}]];i.prototype.setup_palette=function(){s=[],function(){var t,e;for(t=0;2>t;++t)for(e=0;8>e;++e)s.push(a[t][e].color)}(),function(){var t,e,n,i=[0,95,135,175,215,255],o=function(t,e,n){return i[t]+", "+i[e]+", "+i[n]};for(t=0;6>t;++t)for(e=0;6>e;++e)for(n=0;6>n;++n)s.push(o.call(this,t,e,n))}(),function(){var t,e=8,n=function(t){return t+", "+t+", "+t};for(t=0;24>t;++t,e+=10)s.push(n.call(this,e))}()},i.prototype.escape_for_html=function(t){return t.replace(/[&<>]/gm,function(t){return"&"==t?"&amp;":"<"==t?"&lt;":">"==t?"&gt;":void 0})},i.prototype.linkify=function(t){return t.replace(/(https?:\/\/[^\s]+)/gm,function(t){return'<a href="'+t+'">'+t+"</a>"})},i.prototype.ansi_to_html=function(t,e){return this.process(t,e,!0)},i.prototype.ansi_to_text=function(t){var e={};return this.process(t,e,!1)},i.prototype.process=function(t,e,n){var i=this,o=t.split(/\033\[/),s=o.shift(),r=o.map(function(t){return i.process_chunk(t,e,n)});return r.unshift(s),r.join("")},i.prototype.process_chunk=function(t,e,n){e="undefined"==typeof e?{}:e;var i="undefined"!=typeof e.use_classes&&e.use_classes,o=i?"class":"color",r=t.match(/^([!\x3c-\x3f]*)([\d;]*)([\x20-\x2c]*[\x40-\x7e])([\s\S]*)/m);if(!r)return t;var c=r[4],h=r[2].split(";");if(""!==r[1]||"m"!==r[3])return c;if(!n)return c;for(var u=this;h.length>0;){var l=h.shift(),d=parseInt(l);isNaN(d)||0===d?(u.fg=u.bg=null,u.bright=0):1===d?u.bright=1:39==d?u.fg=null:49==d?u.bg=null:d>=30&&38>d?u.fg=a[u.bright][d%10][o]:d>=90&&98>d?u.fg=a[1][d%10][o]:d>=40&&48>d?u.bg=a[0][d%10][o]:d>=100&&108>d?u.bg=a[1][d%10][o]:38!==d&&48!==d||!function(){var t=38===d;if(h.length>=1){var e=h.shift();if("5"===e&&h.length>=1){var n=parseInt(h.shift());if(n>=0&&255>=n)if(i){var o=n>=16?"ansi-palette-"+n:a[n>7?1:0][n%8]["class"];t?u.fg=o:u.bg=o}else s||u.setup_palette.call(u),t?u.fg=s[n]:u.bg=s[n]}else if("2"===e&&h.length>=3){var r=parseInt(h.shift()),c=parseInt(h.shift()),l=parseInt(h.shift());if(r>=0&&255>=r&&c>=0&&255>=c&&l>=0&&255>=l){var f=r+", "+c+", "+l;i?t?(u.fg="ansi-truecolor",u.fg_truecolor=f):(u.bg="ansi-truecolor",u.bg_truecolor=f):t?u.fg=f:u.bg=f}}}}()}if(null===u.fg&&null===u.bg)return c;var f=[],p=[],b={},v=function(t){var e,n=[];for(e in t)t.hasOwnProperty(e)&&n.push("data-"+e+'="'+this.escape_for_html(t[e])+'"');return n.length>0?" "+n.join(" "):""};return u.fg&&(i?(p.push(u.fg+"-fg"),null!==u.fg_truecolor&&(b["ansi-truecolor-fg"]=u.fg_truecolor,u.fg_truecolor=null)):f.push("color:rgb("+u.fg+")")),u.bg&&(i?(p.push(u.bg+"-bg"),null!==u.bg_truecolor&&(b["ansi-truecolor-bg"]=u.bg_truecolor,u.bg_truecolor=null)):f.push("background-color:rgb("+u.bg+")")),i?'<span class="'+p.join(" ")+'"'+v.call(u,b)+">"+c+"</span>":'<span style="'+f.join(";")+'"'+v.call(u,b)+">"+c+"</span>"},o={escape_for_html:function(t){var e=new i;return e.escape_for_html(t)},linkify:function(t){var e=new i;return e.linkify(t)},ansi_to_html:function(t,e){var n=new i;return n.ansi_to_html(t,e)},ansi_to_text:function(t){var e=new i;return e.ansi_to_text(t)},ansi_to_html_obj:function(){return new i}},r&&(t.exports=o),"undefined"!=typeof window&&"undefined"==typeof ender&&(window.ansi_up=o),"function"==typeof define&&define.amd&&define("ansi_up",[],function(){return o})}(Date)}),f=d&&"object"==typeof d&&"default"in d?d["default"]:d,p=f.ansi_to_html,b=f.escape_for_html,v=f.linkify,y=ko,m=y.observable,k=y.observableArray,g=y.computed,w=function(){function t(e){var n=this;u.classCallCheck(this,t),this.$body=document.querySelector("body"),this.parentViewModel=e,this.socket=io.connect(SERVER_URI),this.history=[],this.inputCallback=null,this.lines=k([]),this.command=m(""),this.inputType=m("text"),this.promptStr=m(""),this.maxLines=m(1e3),this.maxHistory=m(1e3),this.echo=m(!1),this.space=m(!1),this.inputHasFocus=m(!0),this.promptFormatted=g(function(){return s(r(n.composedPrompt()))}),this.maxLines.subscribe(function(t){n.lines().length>t&&n.truncateLines()}),this.maxHistory.subscribe(function(t){history().length>t&&n.truncateHistory()}),this.socket.on("connect",this.onConnect.bind(this)),this.socket.on("connecting",this.onConnecting.bind(this)),this.socket.on("disconnect",this.onDisconnect.bind(this)),this.socket.on("connect_failed",this.onConnectFailed.bind(this)),this.socket.on("error",this.onError.bind(this)),this.socket.on("reconnect_failed",this.onReconnectFailed.bind(this)),this.socket.on("reconnect",this.onReconnect.bind(this)),this.socket.on("reconnecting",this.onReconnecting.bind(this)),this.socket.on("output",this.onOutput.bind(this)),this.socket.on("set-prompt",this.onSetPrompt.bind(this)),this.socket.on("request-input",this.onRequestInput.bind(this)),this.socket.on("edit-verb",this.onEditVerb.bind(this)),this.socket.on("edit-function",this.onEditFunction.bind(this)),this.addLine(h("Connecting..."))}return u.createClass(t,[{key:"composedPrompt",value:function(){var t=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return(this.promptStr()+" > "+t).trim()}},{key:"setPrompt",value:function(t,e){this.promptStr(t),e&&this.inputType(e)}},{key:"sendCommand",value:function(){var t=this.command().trim();t&&(this.echoCommand(t),this.addToHistory(t),this.handleClientCommand(t)||(this.socket.connected?this.inputCallback?this.handleInputCallback(t):this.socket.emit("input",t):this.addLine(a("Not connected."))),this.command(""))}},{key:"echoCommand",value:function(t){this.echo()&&"password"!==this.inputType()&&(this.addLine(this.composedPrompt(t)),this.space()&&this.addLine(" "))}},{key:"addToHistory",value:function(t){"password"!==this.inputType()&&(this.history.unshift(t),this.history.length>this.maxHistory()&&this.truncateHistory(),this.currentHistory=-1)}},{key:"handleClientCommand",value:function(t){switch(t){case".clear":return this.lines([]),!0;case".connect":return this.reconnectSocket(),!0;case".disconnect":return this.disconnectSocket(),!0;case".echo on":return this.echo(!0),!0;case".echo off":return this.echo(!1),!0;case".space on":return this.space(!0),!0;case".space off":return this.space(!1),!0;case".new tab":return this.parentViewModel.parentViewModel.newClientTab(),!0;case".close tab":return this.parentViewModel.close(),!0;default:return!1}}},{key:"handleInputCallback",value:function(t){var e=this.inputCallback;this.inputCallback=null,e(t)}},{key:"addLine",value:function(t){this.lines.push(s(r(t))),this.scrollToBottom()}},{key:"addLines",value:function(t){var e=this;t.forEach(function(t){e.addLine(t)})}},{key:"disconnectSocket",value:function(){this.socket.connected?this.socket.disconnect():this.addLine(a("Not connected."))}},{key:"reconnectSocket",value:function(){this.socket.connected?this.addLine(a("Already connected.")):this.socket.connect()}},{key:"scrollToBottom",value:function(){this.$body.scrollTop=this.$body.scrollHeight-window.innerHeight}},{key:"truncateHistory",value:function(){this.history=this.history.slice(0,this.maxHistory())}},{key:"truncateLines",value:function(){var t=this.lines().length-this.maxLines();this.lines(this.lines.slice(t))}},{key:"willClose",value:function(){return this.socket.disconnect(),!0}},{key:"onKeyDown",value:function(t,e){var n="undefined"==typeof e.which?e.keyCode:e.which,i=e.metaKey,o=e.ctrlKey,s=e.shiftKey,r=86===n,a=38===n,c=40===n,h=9===n;if(i&&!r||o&&!r)return!0;if(!this.inputHasFocus()&&(this.inputHasFocus(!0),a||c))return this.onRecall(null,{which:n});if(h){var u=s?-1:1;return this.socket.emit("tab-key-press",{direction:u}),!1}return!0}},{key:"onRecall",value:function(t,e){var n="undefined"==typeof e.which?e.keyCode:e.which;if(0===this.history.length)return!0;switch(n){case 38:return this.currentHistory<this.history.length-1&&this.currentHistory++,this.command(this.history[this.currentHistory]),!1;case 40:this.currentHistory>-1&&this.currentHistory--,this.currentHistory>=0?this.command(this.history[this.currentHistory]):this.command("")}return!0}},{key:"onConnect",value:function(){this.addLine(c("Connected!"))}},{key:"onConnecting",value:function(){this.addLine(h("Connecting..."))}},{key:"onDisconnect",value:function(){this.addLine(a("Disconnected from server.")),this.setPrompt(""),this.inputCallback=null}},{key:"onConnectFailed",value:function(){this.addLine(a("Connection to server failed."))}},{key:"onError",value:function(){this.addLine(a("An unknown error occurred."))}},{key:"onReconnectFailed",value:function(){this.addLine(a("Unable to reconnect to server."))}},{key:"onReconnect",value:function(){}},{key:"onReconnecting",value:function(){}},{key:"onOutput",value:function(t){var e=t.split("\n");this.addLines(e),this.space()&&this.addLine(" ")}},{key:"onSetPrompt",value:function(t){this.setPrompt(t)}},{key:"onEditVerb",value:function(t){this.parentViewModel.parentViewModel.newEditVerbTab(this.socket,t)}},{key:"onEditFunction",value:function(t){this.parentViewModel.parentViewModel.newEditFunctionTab(this.socket,t)}},{key:"onRequestInput",value:function(t,e){var n=this,i=this.promptStr();this.getInputFromUser({},t,function(t){n.setPrompt(i,"text"),e(t)})}},{key:"getInputFromUser",value:function(t,e,n){var i=this;if(0===e.length)return void n(t);var o=u.toArray(e),s=o[0],r=o.slice(1);this.setPrompt(s.label||"input",s.type||"text"),this.inputCallback=function(e){t[s.name||"input"]=e,i.getInputFromUser(t,r,n)}}}]),t}(),C=function(){function t(e){u.classCallCheck(this,t),this.parentViewModel=e,this.templateId="client",this.viewModel=new w(this),this.dirty=!1,this.name=ko.observable("Room.js"),this.active=ko.computed(this.computeActive.bind(this))}return u.createClass(t,[{key:"templateBinding",value:function(){return{name:this.templateId,data:this.viewModel}}},{key:"computeActive",value:function(){return this.parentViewModel.activeTab()===this}},{key:"select",value:function(){this.parentViewModel.activeTab(this),this.viewModel.scrollToBottom(),this.viewModel.inputHasFocus(!0)}},{key:"close",value:function(){this.viewModel.willClose()&&this.parentViewModel.closeTab(this)}},{key:"tabPaneClasses",value:function(){return["tab-pane-client"]}},{key:"hideIfOnlyMe",value:function(){return!0}}]),t}(),_=function(){function t(e,n,i){var o=i.verb,s=i.objectId;u.classCallCheck(this,t),this.parentViewModel=e,this.socket=n,this.objectId=s,this.name=o.name,this.codemirrorOptions={lineNumbers:!0,theme:"tomorrow-night-bright",tabSize:2,indentWithTabs:!1,extraKeys:{Tab:function(t){return t.doc.somethingSelected()?CodeMirror.Pass:t.execCommand("insertSoftTab")}}},this.pattern=ko.observable(o.pattern),this.dobjarg=ko.observable(o.dobjarg),this.preparg=ko.observable(o.preparg),this.iobjarg=ko.observable(o.iobjarg),this.code=ko.observable(o.code),this._pattern=ko.observable(o.pattern),this._dobjarg=ko.observable(o.dobjarg),this._preparg=ko.observable(o.preparg),this._iobjarg=ko.observable(o.iobjarg),this._code=ko.observable(o.code),this.dirty=ko.computed(this.computeDirty.bind(this))}return u.createClass(t,[{key:"computeDirty",value:function(){return this.pattern()!==this._pattern()||this.dobjarg()!==this._dobjarg()||this.preparg()!==this._preparg()||this.iobjarg()!==this._iobjarg()||this.code()!==this._code()}},{key:"save",value:function(){var t=this,e={name:this.name,pattern:this.pattern(),dobjarg:this.dobjarg(),preparg:this.preparg(),iobjarg:this.iobjarg(),code:this.code()},n={objectId:this.objectId,verb:e};return this.socket.connected?void this.socket.emit("save-verb",n,function(e){"saved"===e?(t._pattern(t.pattern()),t._dobjarg(t.dobjarg()),t._preparg(t.preparg()),t._iobjarg(t.iobjarg()),t._code(t.code())):window.alert(e)}):void window.alert(["The client tab that this editor was opened from has been","closed.  You must keep that open for saving to work."].join(" "))}},{key:"willClose",value:function(){var t=["Are you sure you want to close this tab?","You have unsaved changes that will be lost."].join(" ");return this.dirty()?window.confirm(t):!0}},{key:"onKeyDown",value:function(t,e){var n="undefined"==typeof e.which?e.keyCode:e.which,i=e.metaKey,o=e.ctrlKey,s=83===n,r=87===n;return o&&s||i&&s?(this.save(),!1):o&&r||i&&r?(this.parentViewModel.close(),!1):!0}}]),t}(),M=function(){function t(e,n,i){var o=this;u.classCallCheck(this,t),this.parentViewModel=e,this.templateId="verb-editor",this.viewModel=new _(this,n,i),this.name=ko.observable(i.objectId+"."+i.verb.name),this.active=ko.computed(function(){return e.activeTab()===o}),this.dirty=ko.computed(function(){return o.viewModel.dirty()})}return u.createClass(t,[{key:"templateBinding",value:function(){return{name:this.templateId,data:this.viewModel}}},{key:"select",value:function(){this.parentViewModel.activeTab(this)}},{key:"close",value:function(){this.viewModel.willClose()&&this.parentViewModel.closeTab(this)}},{key:"tabPaneClasses",value:function(){return["tab-pane-editor","tab-pane-verb-editor"]}},{key:"hideIfOnlyMe",value:function(){return!1}}]),t}(),T=function(){function t(e,n,i){var o=this,s=i.objectId,r=i.src,a=i.name;u.classCallCheck(this,t),this.parentViewModel=e,this.socket=n,this.objectId=s,this.src=r,this.name=a,this.codemirrorOptions={lineNumbers:!0,theme:"tomorrow-night-bright",tabSize:2,indentWithTabs:!1,extraKeys:{Tab:function(t){return t.doc.somethingSelected()?CodeMirror.Pass:t.execCommand("insertSoftTab")}}},this.code=ko.observable(this.src),this._code=ko.observable(this.src),this.dirty=ko.computed(function(){return o.code()!==o._code()})}return u.createClass(t,[{key:"save",value:function(){var t=this,e={name:this.name,src:this.code(),objectId:this.objectId};return this.socket.connected?void this.socket.emit("save-function",e,function(e){"saved"===e?t._code(t.code()):window.alert(e)}):void window.alert(["The client tab that this editor was opened from has been","closed.  You must keep that open for saving to work."].join(" "))}},{key:"willClose",value:function(){var t=["Are you sure you want to close this tab?","You have unsaved changes that will be lost."].join(" ");return this.dirty()?window.confirm(t):!0}},{key:"onKeyDown",value:function(t,e){var n="undefined"==typeof e.which?e.keyCode:e.which,i=e.metaKey,o=e.ctrlKey,s=83===n,r=87===n;return o&&s||i&&s?(this.save(),!1):o&&r||i&&r?(this.parentViewModel.close(),!1):!0}}]),t}(),j=function(){function t(e,n,i){var o=this;u.classCallCheck(this,t),this.parentViewModel=e,this.templateId="function-editor",this.viewModel=new T(this,n,i),this.name=ko.observable(i.objectId+"."+i.name),this.active=ko.computed(function(){return e.activeTab()===o}),this.dirty=ko.computed(function(){return o.viewModel.dirty()})}return u.createClass(t,[{key:"templateBinding",value:function(){return{name:this.templateId,data:this.viewModel}}},{key:"select",value:function(){this.parentViewModel.activeTab(this)}},{key:"close",value:function(){this.viewModel.willClose()&&this.parentViewModel.closeTab(this)}},{key:"tabPaneClasses",value:function(){return["tab-pane-editor","tab-pane-function-editor"]}},{key:"hideIfOnlyMe",value:function(){return!1}}]),t}(),V=function(){function t(){u.classCallCheck(this,t),this.activeTab=ko.observable(),this.tabs=ko.observableArray([new C(this)]),this.activeViewModel=ko.computed(this.computeActiveViewModel.bind(this)),this.hidden=ko.computed(this.computeHidden.bind(this)),this.visible=ko.computed(this.computeVisible.bind(this)),this.tabPaneClasses=ko.computed(this.computeTabPaneClasses.bind(this)),this.templateBinding=ko.computed(this.computeTemplateBinding.bind(this)),this.activeTab(this.tabs()[0])}return u.createClass(t,[{key:"computeActiveViewModel",value:function(){var t=this.activeTab();return t?t.viewModel:this}},{key:"computeHidden",value:function(){var t=this.tabs().length,e=this.tabs()[0];return 0===t||1===t&&e.hideIfOnlyMe()}},{key:"computeVisible",value:function(){return!this.hidden()}},{key:"computeTabPaneClasses",value:function(){var t=this.activeTab(),e=void 0;return e=t?t.tabPaneClasses():[],this.visible()&&e.push("tabs-visible"),e.join(" ")}},{key:"computeTemplateBinding",value:function(){var t=this.activeTab();return t?t.templateBinding():{name:"no-tabs",data:this}}},{key:"tabPaneClasses",value:function(){return[]}},{key:"newClientTab",value:function(){var t=new C(this);this.tabs.push(t),t.select()}},{key:"newEditVerbTab",value:function(t,e){var n=new M(this,t,e);this.tabs.push(n),n.select()}},{key:"newEditFunctionTab",value:function(t,e){var n=new j(this,t,e);this.tabs.push(n),n.select()}},{key:"closeTab",value:function(t){var e=this.tabs().length-1,n=this.tabs.indexOf(t);n===e&&n--,this.tabs.remove(t),e>0?this.tabs()[n].select():this.activeTab(null)}},{key:"onKeyDown",value:function(){var t=this.activeViewModel();if(t&&t.onKeyDown){for(var e=arguments.length,n=Array(e),i=0;e>i;i++)n[i]=arguments[i];return t.onKeyDown.apply(t,n)}return!0}},{key:"onKeyUp",value:function(){var t=this.activeViewModel();if(t&&t.onKeyUp){for(var e=arguments.length,n=Array(e),i=0;e>i;i++)n[i]=arguments[i];return t.onKeyUp.apply(t,n)}return!0}}]),t}();l.register(),t.TabsViewModel=V}(this.bundle=this.bundle||{});